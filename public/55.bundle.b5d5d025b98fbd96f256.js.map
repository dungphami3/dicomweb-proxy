{"version":3,"file":"55.bundle.b5d5d025b98fbd96f256.js","mappings":"kOAAA,MAWA,EAX+BA,IAC7B,MAAM,KAAEC,EAAI,cAAEC,GAAkBF,EAChC,GAAKC,EACL,OAAOA,EAAKE,KAAIC,IACd,IAAKA,EAAM,OACX,MAAMC,EAAYD,EAAKC,WAAaH,EACpC,IAAKG,EAAW,MAAM,IAAIC,MAAO,oBAAmBF,KACpD,OAAOC,EAAU,IAAKL,EAAOI,QAAO,GACpC,E,kBCoBG,MAoGP,EApGkCG,KAY5B,IAZ6B,QACjCC,EAAU,GAAE,SACZC,EAAW,GAAE,WACbC,EAAa,GAAE,YACfC,EAAc,GAAE,cAChBT,EAAgBA,UAOjBK,EACC,OAAQP,IACN,MAMMY,EAAU,2DAEhB,OACEC,EAAAA,cAAAA,EAAAA,SAAA,KACGL,GAAWA,EAAQM,OAAS,GAC3BD,EAAAA,cAAA,OACE,UAAS,4BACTE,UAAWC,IAAWJ,EAbT,kDAeZK,EAAuB,IAAKjB,EAAOC,KAAMO,EAASN,mBAGtDO,GAAYA,EAASK,OAAS,GAC7BD,EAAAA,cAAA,OACE,UAAS,6BACTE,UAAWC,IAAWJ,EAnB5B,6DAqBOK,EAAuB,IACnBjB,EACHC,KAAMQ,EACNP,mBAILS,GAAeA,EAAYG,OAAS,GACnCD,EAAAA,cAAA,OACE,UAAS,gCACTE,UAAWC,IAAWJ,EA7B5B,gEA+BOK,EAAuB,IACnBjB,EACHC,KAAMU,EACNT,mBAILQ,GAAcA,EAAWI,OAAS,GACjCD,EAAAA,cAAA,OACE,UAAS,+BACTE,UAAWC,IAAWJ,EAxCN,qDA0CfK,EAAuB,IACnBjB,EACHC,KAAMS,EACNR,mBAIL,CAEN,EA8BH,CAAkC,CAAC,G,0BC7HnC,MAAM,eAAEgB,GAAmBC,EAAAA,IAE3BD,EAAeE,sCAAwC,IAC9C,M,0BCJT,SAASC,EAAYC,GACnB,QAAqB,iBAALA,GAAiBC,MAAMC,QAAQF,GACjD,CAEA,MAAMG,EAAa,CACjB,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,MAQa,SAASC,EACtBC,EACAC,GAMA,GAAIL,MAAMC,QAAQG,GAAM,CAItB,OAHeA,EAAIxB,KAAI0B,GACrBR,EAAYQ,GAAKA,EAAIH,EAA0BG,EAAGD,IAGtD,CAAO,OAAIP,EAAYM,IAGrBG,OAAOC,KAAKJ,GAAKK,SAAQC,IACA,OAAnBN,EAAIM,GAAKC,OAAkBP,EAAIM,GAAKE,UAC/BR,EAAIM,GAAKC,MACPX,MAAMC,QAAQG,EAAIM,GAAKC,QAAUP,EAAIM,GAAKE,KACrB,IAA1BR,EAAIM,GAAKC,MAAMpB,QAAgBa,EAAIM,GAAKC,MAAM,GAAGE,aACnDC,EAAAA,cAAAA,eACEV,EAAIM,GAAKC,MAAM,GACfN,EACAA,EAAQU,kBAGVX,EAAIM,GAAKG,YAAcT,EAAIM,GAAKC,MAAM,GAAGE,YAIV,WAA7BG,OAAOC,SAASC,UAChBd,EAAIM,GAAKG,YAAYM,WAAW,WAEhCf,EAAIM,GAAKG,YAAcT,EAAIM,GAAKG,YAAYO,QAC1C,QACA,kBAGGhB,EAAIM,GAAKC,OACPT,EAAWmB,SAASjB,EAAIM,GAAKE,IACtCR,EAAIM,GAAKC,MAAQP,EAAIM,GAAKC,MAAM/B,KAAImB,IAAMA,IAE1CK,EAAIM,GAAKC,MAAQP,EAAIM,GAAKC,MAAM/B,KAAI0C,GAClCnB,EAA0BmB,EAAOjB,KAGvC,IAjCKD,CAqCX,CCxDA,MAAMmB,UAAgCC,EAAAA,UAcpCC,YAAYhD,GACViD,MAAMjD,GAAO,KAdfkD,MAAQ,CACNC,MAAO,KACPC,UAAU,GACX,KAEDC,uBAAiB,OACjBC,OAAc,KAAM,KACpBC,cAAqB,KAAM,KAE3BC,UAAY3C,EAAAA,YAAiB,KAC7B4C,eAAiB5C,EAAAA,YAAiB,KAClC6C,qBAAe,OAmQfC,yBAA2B,KACzB,MAAM,kBACJC,EAAiB,cACjBC,EAAa,oBACbC,GACEC,KAAK/D,MAEL6D,IAAkBC,GACpBF,EAAkBC,EACpB,EACD,KA+CDG,eAAiB,KACfD,KAAKL,iBAAiB,EAxTtB,MAAM,kBAAEL,GAAsBU,KAAK/D,MAAMiE,gBAAgBC,SACzDH,KAAKV,kBAAoBA,EACzBU,KAAKL,gBAAkBS,KAAS,KAC1BJ,KAAKT,QAAQS,KAAKT,OAAOc,QAAQ,GACpC,IACL,CA4BAC,aAAaC,GAAiC,IAAnBC,IAAUC,UAAA1D,OAAA,QAAA2D,IAAAD,UAAA,KAAAA,UAAA,GACnC,MAAME,EAAU5C,OAAO6C,sBAAsBZ,KAAKT,QAC5CsB,EAAiBF,EAAQG,MAAKC,GAAuB,kBAAlBA,EAAEC,cACrCC,EAAWN,EAAQG,MAAKC,GAAuB,YAAlBA,EAAEC,cAC/BE,EAAOP,EAAQG,MAAKC,GAAuB,QAAlBA,EAAEC,cAC3BG,EAAUR,EAAQG,MAAKC,GAAuB,WAAlBA,EAAEC,cAE9BI,EAAUpB,KAAKT,OAAOsB,GAAgBQ,8BAC1CrB,KAAKT,OAAO2B,GAAMI,mBAAmBf,IAGvC,IAAKa,EACH,OAAO,KAGT,MAAMG,EAAgBvB,KAAKT,OAAOiC,mBAChCJ,EACApB,KAAKT,OAAO0B,GAAUQ,SACtBzB,KAAKT,OAAO4B,IAKd,OAHII,GAAiBf,GACnBR,KAAKV,kBAAkBoC,iBAAiBH,GAEnCA,CACT,CAIAI,gCAAgClC,EAAWmC,GA6IzC5B,KAAKV,kBAAkBuC,mBAEvB,IAAIC,EAAeF,EACS,OAAxBA,EAAWG,WAEbD,EAAeF,EAAWI,uBAE5BC,QAAQC,IAAI,0BAA2BJ,QAnJpBH,WACjB,MACEpC,OAAQ4C,EACRV,SAAUW,SACF,mCAGJC,EAAmBF,EAAsBG,kBAEzCC,EF9FG,SAA0B/F,GAGtC,IAHuC,iBACxCgG,EAAgB,gBAChBtC,GACD1D,EACC,MAAM+B,EAAmBC,OAAOiE,OAAOC,YAAY5B,MACjD6B,GAAMA,EAAGC,aAAeJ,EAAiBK,oBAErC,0BAAEC,GAA8B5C,EAAgBC,UAEhD,SAAE4C,EAAQ,WAAEC,EAAU,WAAEC,GAAe1E,EAAiB2E,cAExDC,EAAa,CACjBC,IAAKL,GAAY,cACjBC,aACAC,aACAI,QAASP,EAA0BQ,yBACnCC,iBAAkBC,EAAAA,GAAaC,uBAG3BlB,EAAS,IAAInF,EAAAA,IAAID,eAAegG,GAgEtC,OA/DAZ,EAAOmB,QAAUP,EAAWC,IAEc,eAAtCZ,EAAiBK,mBAgBnBN,EAAOoB,uBAAyBhC,UAC9B,KAAM,qBAAsB9D,GAC1B,MAAM,IAAItB,MACR,mEAGJ,KAAM,sBAAuBsB,GAC3B,MAAM,IAAItB,MACR,oEAGJ,KAAM,mBAAoBsB,GACxB,MAAM,IAAItB,MACR,iEAGJ,KAAM,iBAAkBsB,GACtB,MAAM,IAAItB,MACR,+DAGJ0F,QAAQC,IACL,mBAAkBrE,EAAQ+F,aAAaC,0BACtChG,EAAQiG,kBAIZ,MAAMC,EAAWC,EAAAA,mBAAmBC,YAClCpG,EAAQqG,iBACRrG,EAAQsG,kBACRtG,EAAQiG,gBAOV,OAJqBtG,MAAMC,QAAQI,EAAQ+F,cACvC/F,EAAQ+F,aACR/F,EAAQ+F,aAAaQ,MAAM,MAEXhI,KAAIiI,GACtB7G,MAAMC,QAAQsG,EAASO,WACnBP,EAASO,WAAWD,EAAK,GACzBN,EAASO,WACd,GAIE/B,CACT,CEUqBgC,CAAkB,CAC/B/B,iBAAkBxC,KAAK/D,MAAMuG,iBAC7BtC,gBAAiBF,KAAK/D,MAAMiE,kBAIxBsE,EAAsB,GA2C5B/C,EAASxD,SAAQwG,IAGfA,EAAEC,UACuB,iBAAhBD,EAAEC,UACLD,EAAEC,UAAUN,MAAM,MAClBK,EAAEC,UAER,MAAMC,EAAOhH,EACXiH,EAAAA,QAAAA,KAAWC,oBAAoBC,oBAAoBL,GACnD,CACEM,iBAAkBN,EAAEM,iBACpBC,kBAAmBP,EAAEO,kBACrBzG,iBAAkByB,KAAK/D,MAAMgJ,WAAWC,cAGvCP,EAAK,cAGRA,EAAK,YAAc,CACjBvG,GAAI,KACJD,MAAO,CACL,CACE,WAAY,CACVC,GAAI,KACJD,MAAO,CAAC,UAMlB,MAAMgH,EAAQ,IAAI/C,EAAcgD,4BAA4B,CAC1D3D,SAAUkD,IAGNU,EAAcF,EAAMT,UAAU,GAChB,WAAhBW,GAA4C,cAAhBA,GAC9Bb,EAAac,KAAKH,EACpB,IAIF,MAAMtH,EAAU,CACd0E,SACAd,SAAU+C,EACVe,kBAAkB,EAClBC,SAAU,CAAC,WAAY,aAGzBxF,KAAKT,OAAS,IAAI8C,EAAiBxE,GAGjCmC,KAAKN,gBACLM,KAAKN,eAAe+F,SACpBzF,KAAKT,OAAOmG,oBAEZ1F,KAAKT,OAAOmG,mBAAmB,CAC7BC,QAAS3F,KAAKN,eAAe+F,QAC7BG,YAAa,CAAC,EAAG,GACjBC,UAAU,EACV7I,UAAW,sBAIfgD,KAAKT,OAAOuG,OAAO,CAAErG,cAErB,MAAM,iBAAEsF,EAAgB,kBAAEC,GAAsBpD,EAEhD5B,KAAKR,cAAgBQ,KAAKV,kBAAkByG,UAC1C/F,KAAKT,OACLS,KAAK/D,MAAM6D,cACXL,EACAsF,EACAC,GAGFhF,KAAKR,cAAcwG,wBAAwBzF,OAGzC,EAYE0F,CAAWnE,EAAaoE,QAEF,OAAxBtE,EAAWG,UACbH,EAAWuE,KAAKrE,EAEpB,CAEAsE,oBACE,MAAM,YAAEC,EAAW,cAAEvG,GAAkBE,KAAK/D,MACtC2F,EAAayE,EAAYvG,GAC/BE,KAAKsG,0BAA0BtG,KAAKP,UAAUgG,QAAS7D,GAAY2E,MACjE,KACEvG,KAAKwG,SAAS,CAAEnH,UAAU,GAAO,GAGvC,CAEAoH,mBACEC,EACAC,EACAC,GAEA,GACE5G,KAAKR,eACLkH,EAAUL,cAAgBrG,KAAK/D,MAAMoK,YACrC,CACA,MAAM,YAAEA,GAAgBrG,KAAK/D,MACvB2F,EAAayE,EAAY,GAK/B,GAHArG,KAAKV,kBAAkBuC,mBAGK,OAAxBD,EAAWG,SAAmB,CAChC,MAAM8E,EAAuBjF,EAAWI,sBACxCJ,EAAWuE,KAAKU,EAClB,CACF,CACF,CAEAC,uBACE9G,KAAKV,kBAAkByH,aAAa/G,KAAKT,OAC3C,CAcAuG,SACE,MAAMkB,EAAQ,CAAEC,MAAO,OAAQC,OAAQ,QACjCtF,EAAa5B,KAAK/D,MAAMoK,YAAY,GACpCc,EAAgBvF,EAAWuF,eAAiBvF,EAAWmC,SAE7D,OACEjH,EAAAA,cAAA,OACEE,UAAW,wBACXgK,MAAOA,EACPI,QAASpH,KAAKJ,0BAEd9C,EAAAA,cAAA,OAAKkK,MAAO,IAAKA,EAAOK,QAAS,SAC/BvK,EAAAA,cAAA,OAAKkK,MAAO,IAAKA,GAASM,IAAKtH,KAAKN,gBAClC5C,EAAAA,cAAA,OACEkK,MAAO,CAAEO,SAAU,WAAYL,OAAQ,OAAQD,MAAO,SAErDrF,GAAcuF,EAAcK,SAC3B1K,EAAAA,cAAC2K,EAAe,CACd7F,WAAYA,EACZmC,SAAUnC,EAAWmC,SACrBtC,SAAUG,EAAWH,cAM9BiG,EAAAA,IACC5K,EAAAA,cAAC4K,EAAAA,GAAmB,CAClBC,aAAW,EACXC,cAAY,EACZC,SAAU7H,KAAKC,iBAGlBD,KAAKb,MAAMC,MACVtC,EAAAA,cAAA,UAAKgL,KAAKC,UAAU/H,KAAKb,MAAMC,QAE/BtC,EAAAA,cAAA,OAAKkK,MAAOA,EAAOM,IAAKtH,KAAKP,YAE9BO,KAAKb,MAAME,SAAW,KACrBvC,EAAAA,cAACkL,EAAAA,GAAwB,CAAChL,UAAW,2BAI7C,EAtUI+B,EAwBGkJ,UAAY,CACjBC,aAAcC,IAAAA,OACdpI,oBAAqBoI,IAAAA,OACrBtI,kBAAmBsI,IAAAA,KAGnB9B,YAAa8B,IAAAA,MACbrI,cAAeqI,IAAAA,OACfC,cAAeD,IAAAA,OACflD,WAAYkD,IAAAA,OACZE,gBAAiBF,IAAAA,OACjBG,kBAAmBH,IAAAA,MAGnBjI,gBAAiBiI,IAAAA,OACjB3F,iBAAkB2F,IAAAA,OAClBI,gBAAiBJ,IAAAA,QAqSrB,S","sources":["webpack:///../../../extensions/dicom-microscopy/src/components/ViewportOverlay/listComponentGenerator.tsx","webpack:///../../../extensions/dicom-microscopy/src/components/ViewportOverlay/index.tsx","webpack:///../../../extensions/dicom-microscopy/src/utils/dicomWebClient.ts","webpack:///../../../extensions/dicom-microscopy/src/utils/cleanDenaturalizedDataset.ts","webpack:///../../../extensions/dicom-microscopy/src/DicomMicroscopyViewport.tsx"],"sourcesContent":["const listComponentGenerator = props => {\r\n  const { list, itemGenerator } = props;\r\n  if (!list) return;\r\n  return list.map(item => {\r\n    if (!item) return;\r\n    const generator = item.generator || itemGenerator;\r\n    if (!generator) throw new Error(`No generator for ${item}`);\r\n    return generator({ ...props, item });\r\n  });\r\n};\r\n\r\nexport default listComponentGenerator;\r\n","import React from 'react';\r\nimport classnames from 'classnames';\r\n\r\nimport listComponentGenerator from './listComponentGenerator';\r\nimport './ViewportOverlay.css';\r\nimport {\r\n  formatDICOMDate,\r\n  formatDICOMTime,\r\n  formatNumberPrecision,\r\n  formatPN,\r\n} from './utils';\r\n\r\ninterface OverlayItem {\r\n  id: string;\r\n  title: string;\r\n  value?: (props: any) => string;\r\n  condition?: (props: any) => boolean;\r\n  contents?: (props: any) => { className: string; value: any };\r\n  generator?: (props: any) => any;\r\n}\r\n\r\n/**\r\n *\r\n * @param {*} config is a configuration object that defines four lists of elements,\r\n * one topLeft, topRight, bottomLeft, bottomRight contents.\r\n * @param {*} extensionManager is used to load the image data.\r\n * @returns\r\n */\r\nexport const generateFromConfig = ({\r\n  topLeft = [],\r\n  topRight = [],\r\n  bottomLeft = [],\r\n  bottomRight = [],\r\n  itemGenerator = () => {},\r\n}: {\r\n  topLeft?: OverlayItem[];\r\n  topRight?: OverlayItem[];\r\n  bottomLeft?: OverlayItem[];\r\n  bottomRight?: OverlayItem[];\r\n  itemGenerator?: (props: any) => any;\r\n}) => {\r\n  return (props: any) => {\r\n    const topLeftClass = 'top-viewport left-viewport text-primary-light';\r\n    const topRightClass =\r\n      'top-viewport right-viewport-scrollbar text-primary-light';\r\n    const bottomRightClass =\r\n      'bottom-viewport right-viewport-scrollbar text-primary-light';\r\n    const bottomLeftClass = 'bottom-viewport left-viewport text-primary-light';\r\n    const overlay = 'absolute pointer-events-none microscopy-viewport-overlay';\r\n\r\n    return (\r\n      <>\r\n        {topLeft && topLeft.length > 0 && (\r\n          <div\r\n            data-cy={'viewport-overlay-top-left'}\r\n            className={classnames(overlay, topLeftClass)}\r\n          >\r\n            {listComponentGenerator({ ...props, list: topLeft, itemGenerator })}\r\n          </div>\r\n        )}\r\n        {topRight && topRight.length > 0 && (\r\n          <div\r\n            data-cy={'viewport-overlay-top-right'}\r\n            className={classnames(overlay, topRightClass)}\r\n          >\r\n            {listComponentGenerator({\r\n              ...props,\r\n              list: topRight,\r\n              itemGenerator,\r\n            })}\r\n          </div>\r\n        )}\r\n        {bottomRight && bottomRight.length > 0 && (\r\n          <div\r\n            data-cy={'viewport-overlay-bottom-right'}\r\n            className={classnames(overlay, bottomRightClass)}\r\n          >\r\n            {listComponentGenerator({\r\n              ...props,\r\n              list: bottomRight,\r\n              itemGenerator,\r\n            })}\r\n          </div>\r\n        )}\r\n        {bottomLeft && bottomLeft.length > 0 && (\r\n          <div\r\n            data-cy={'viewport-overlay-bottom-left'}\r\n            className={classnames(overlay, bottomLeftClass)}\r\n          >\r\n            {listComponentGenerator({\r\n              ...props,\r\n              list: bottomLeft,\r\n              itemGenerator,\r\n            })}\r\n          </div>\r\n        )}\r\n      </>\r\n    );\r\n  };\r\n};\r\n\r\nconst itemGenerator = (props: any) => {\r\n  const { item } = props;\r\n  const { title, value: valueFunc, condition, contents } = item;\r\n  props.image = { ...props.image, ...props.metadata };\r\n  props.formatDate = formatDICOMDate;\r\n  props.formatTime = formatDICOMTime;\r\n  props.formatPN = formatPN;\r\n  props.formatNumberPrecision = formatNumberPrecision;\r\n  if (condition && !condition(props)) return null;\r\n  if (!contents && !valueFunc) return null;\r\n  const value = valueFunc && valueFunc(props);\r\n  const contentsValue = (contents && contents(props)) || [\r\n    { className: 'mr-1', value: title },\r\n    { classname: 'mr-1 font-light', value },\r\n  ];\r\n\r\n  return (\r\n    <div key={item.id} className=\"flex flex-row\">\r\n      {contentsValue.map((content, idx) => (\r\n        <span key={idx} className={content.className}>\r\n          {content.value}\r\n        </span>\r\n      ))}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default generateFromConfig({});\r\n","import { api } from 'dicomweb-client';\r\nimport { errorHandler, DicomMetadataStore } from '@ohif/core';\r\n\r\nconst { DICOMwebClient } = api;\r\n\r\nDICOMwebClient._buildMultipartAcceptHeaderFieldValue = () => {\r\n  return '*/*';\r\n};\r\n\r\n/**\r\n * create a DICOMwebClient object to be used by Dicom Microscopy Viewer\r\n *\r\n * Referenced the code from `/extensions/default/src/DicomWebDataSource/index.js`\r\n *\r\n * @param param0\r\n * @returns\r\n */\r\nexport default function getDicomWebClient({\r\n  extensionManager,\r\n  servicesManager,\r\n}) {\r\n  const dataSourceConfig = window.config.dataSources.find(\r\n    ds => ds.sourceName === extensionManager.activeDataSource\r\n  );\r\n  const { userAuthenticationService } = servicesManager.services;\r\n\r\n  const { wadoRoot, staticWado, singlepart } = dataSourceConfig.configuration;\r\n\r\n  const wadoConfig = {\r\n    url: wadoRoot || '/dicomlocal',\r\n    staticWado,\r\n    singlepart,\r\n    headers: userAuthenticationService.getAuthorizationHeader(),\r\n    errorInterceptor: errorHandler.getHTTPErrorHandler(),\r\n  };\r\n\r\n  const client = new api.DICOMwebClient(wadoConfig);\r\n  client.wadoURL = wadoConfig.url;\r\n\r\n  if (extensionManager.activeDataSource === 'dicomlocal') {\r\n    /**\r\n     * For local data source, override the retrieveInstanceFrames() method of the\r\n     * dicomweb-client to retrieve image data from memory cached metadata.\r\n     * Other methods of the client doesn't matter, as we are feeding the DMV\r\n     * with the series metadata already.\r\n     *\r\n     * @param {Object} options\r\n     * @param {String} options.studyInstanceUID - Study Instance UID\r\n     * @param {String} options.seriesInstanceUID - Series Instance UID\r\n     * @param {String} options.sopInstanceUID - SOP Instance UID\r\n     * @param {String} options.frameNumbers - One-based indices of Frame Items\r\n     * @param {Object} [options.queryParams] - HTTP query parameters\r\n     * @returns {ArrayBuffer[]} Rendered Frame Items as byte arrays\r\n     */\r\n    //\r\n    client.retrieveInstanceFrames = async options => {\r\n      if (!('studyInstanceUID' in options)) {\r\n        throw new Error(\r\n          'Study Instance UID is required for retrieval of instance frames'\r\n        );\r\n      }\r\n      if (!('seriesInstanceUID' in options)) {\r\n        throw new Error(\r\n          'Series Instance UID is required for retrieval of instance frames'\r\n        );\r\n      }\r\n      if (!('sopInstanceUID' in options)) {\r\n        throw new Error(\r\n          'SOP Instance UID is required for retrieval of instance frames'\r\n        );\r\n      }\r\n      if (!('frameNumbers' in options)) {\r\n        throw new Error(\r\n          'frame numbers are required for retrieval of instance frames'\r\n        );\r\n      }\r\n      console.log(\r\n        `retrieve frames ${options.frameNumbers.toString()} of instance ${\r\n          options.sopInstanceUID\r\n        }`\r\n      );\r\n\r\n      const instance = DicomMetadataStore.getInstance(\r\n        options.studyInstanceUID,\r\n        options.seriesInstanceUID,\r\n        options.sopInstanceUID\r\n      );\r\n\r\n      const frameNumbers = Array.isArray(options.frameNumbers)\r\n        ? options.frameNumbers\r\n        : options.frameNumbers.split(',');\r\n\r\n      return frameNumbers.map(fr =>\r\n        Array.isArray(instance.PixelData)\r\n          ? instance.PixelData[+fr - 1]\r\n          : instance.PixelData\r\n      );\r\n    };\r\n  }\r\n\r\n  return client;\r\n}\r\n","import { dicomWebUtils } from '@ohif/extension-default';\r\n\r\nfunction isPrimitive(v: any) {\r\n  return !(typeof v == 'object' || Array.isArray(v));\r\n}\r\n\r\nconst vrNumerics = [\r\n  'DS',\r\n  'FL',\r\n  'FD',\r\n  'IS',\r\n  'OD',\r\n  'OF',\r\n  'OL',\r\n  'OV',\r\n  'SL',\r\n  'SS',\r\n  'SV',\r\n  'UL',\r\n  'US',\r\n  'UV',\r\n];\r\n\r\n/**\r\n * Specialized for DICOM JSON format dataset cleaning.\r\n * @param obj\r\n * @returns\r\n */\r\nexport default function cleanDenaturalizedDataset(\r\n  obj: any,\r\n  options: {\r\n    StudyInstanceUID: string;\r\n    SeriesInstanceUID: string;\r\n    dataSourceConfig: unknown;\r\n  }\r\n): any {\r\n  if (Array.isArray(obj)) {\r\n    const newAry = obj.map(o =>\r\n      isPrimitive(o) ? o : cleanDenaturalizedDataset(o, options)\r\n    );\r\n    return newAry;\r\n  } else if (isPrimitive(obj)) {\r\n    return obj;\r\n  } else {\r\n    Object.keys(obj).forEach(key => {\r\n      if (obj[key].Value === null && obj[key].vr) {\r\n        delete obj[key].Value;\r\n      } else if (Array.isArray(obj[key].Value) && obj[key].vr) {\r\n        if (obj[key].Value.length === 1 && obj[key].Value[0].BulkDataURI) {\r\n          dicomWebUtils.fixBulkDataURI(\r\n            obj[key].Value[0],\r\n            options,\r\n            options.dataSourceConfig\r\n          );\r\n\r\n          obj[key].BulkDataURI = obj[key].Value[0].BulkDataURI;\r\n\r\n          // prevent mixed-content blockage\r\n          if (\r\n            window.location.protocol === 'https:' &&\r\n            obj[key].BulkDataURI.startsWith('http:')\r\n          ) {\r\n            obj[key].BulkDataURI = obj[key].BulkDataURI.replace(\r\n              'http:',\r\n              'https:'\r\n            );\r\n          }\r\n          delete obj[key].Value;\r\n        } else if (vrNumerics.includes(obj[key].vr)) {\r\n          obj[key].Value = obj[key].Value.map(v => +v);\r\n        } else {\r\n          obj[key].Value = obj[key].Value.map(entry =>\r\n            cleanDenaturalizedDataset(entry, options)\r\n          );\r\n        }\r\n      }\r\n    });\r\n    return obj;\r\n  }\r\n}\r\n","import React, { Component } from 'react';\r\nimport ReactResizeDetector from 'react-resize-detector';\r\nimport PropTypes from 'prop-types';\r\nimport debounce from 'lodash.debounce';\r\nimport { LoadingIndicatorProgress } from '@ohif/ui';\r\n\r\nimport './DicomMicroscopyViewport.css';\r\nimport ViewportOverlay from './components/ViewportOverlay';\r\nimport getDicomWebClient from './utils/dicomWebClient';\r\nimport dcmjs from 'dcmjs';\r\nimport cleanDenaturalizedDataset from './utils/cleanDenaturalizedDataset';\r\nimport MicroscopyService from './services/MicroscopyService';\r\n\r\nfunction transformImageTypeUnnaturalized(entry) {\r\n  if (entry.vr === 'CS') {\r\n    return {\r\n      vr: 'US',\r\n      Value: entry.Value[0].split('\\\\'),\r\n    };\r\n  }\r\n  return entry;\r\n}\r\n\r\nclass DicomMicroscopyViewport extends Component {\r\n  state = {\r\n    error: null as any,\r\n    isLoaded: false,\r\n  };\r\n\r\n  microscopyService: MicroscopyService;\r\n  viewer: any = null; // dicom-microscopy-viewer instance\r\n  managedViewer: any = null; // managed wrapper of microscopy-dicom extension\r\n\r\n  container = React.createRef();\r\n  overlayElement = React.createRef();\r\n  debouncedResize: () => any;\r\n\r\n  constructor(props: any) {\r\n    super(props);\r\n\r\n    const { microscopyService } = this.props.servicesManager.services;\r\n    this.microscopyService = microscopyService;\r\n    this.debouncedResize = debounce(() => {\r\n      if (this.viewer) this.viewer.resize();\r\n    }, 100);\r\n  }\r\n\r\n  static propTypes = {\r\n    viewportData: PropTypes.object,\r\n    activeViewportIndex: PropTypes.number,\r\n    setViewportActive: PropTypes.func,\r\n\r\n    // props from OHIF Viewport Grid\r\n    displaySets: PropTypes.array,\r\n    viewportIndex: PropTypes.number,\r\n    viewportLabel: PropTypes.string,\r\n    dataSource: PropTypes.object,\r\n    viewportOptions: PropTypes.object,\r\n    displaySetOptions: PropTypes.array,\r\n\r\n    // other props from wrapping component\r\n    servicesManager: PropTypes.object,\r\n    extensionManager: PropTypes.object,\r\n    commandsManager: PropTypes.object,\r\n  };\r\n\r\n  /**\r\n   * Get the nearest ROI from the mouse click point\r\n   *\r\n   * @param event\r\n   * @param autoselect\r\n   * @returns\r\n   */\r\n  getNearbyROI(event: Event, autoselect = true) {\r\n    const symbols = Object.getOwnPropertySymbols(this.viewer);\r\n    const _drawingSource = symbols.find(p => p.description === 'drawingSource');\r\n    const _pyramid = symbols.find(p => p.description === 'pyramid');\r\n    const _map = symbols.find(p => p.description === 'map');\r\n    const _affine = symbols.find(p => p.description === 'affine');\r\n\r\n    const feature = this.viewer[_drawingSource].getClosestFeatureToCoordinate(\r\n      this.viewer[_map].getEventCoordinate(event)\r\n    );\r\n\r\n    if (!feature) {\r\n      return null;\r\n    }\r\n\r\n    const roiAnnotation = this.viewer._getROIFromFeature(\r\n      feature,\r\n      this.viewer[_pyramid].metadata,\r\n      this.viewer[_affine]\r\n    );\r\n    if (roiAnnotation && autoselect) {\r\n      this.microscopyService.selectAnnotation(roiAnnotation);\r\n    }\r\n    return roiAnnotation;\r\n  }\r\n\r\n  // install the microscopy renderer into the web page.\r\n  // you should only do this once.\r\n  async installOpenLayersRenderer(container, displaySet) {\r\n    const loadViewer = async metadata => {\r\n      const {\r\n        viewer: DicomMicroscopyViewer,\r\n        metadata: metadataUtils,\r\n      } = await import(\r\n        /* webpackChunkName: \"dicom-microscopy-viewer\" */ 'dicom-microscopy-viewer'\r\n      );\r\n      const microscopyViewer = DicomMicroscopyViewer.VolumeImageViewer;\r\n\r\n      const client = getDicomWebClient({\r\n        extensionManager: this.props.extensionManager,\r\n        servicesManager: this.props.servicesManager,\r\n      });\r\n\r\n      // Parse, format, and filter metadata\r\n      const volumeImages: any[] = [];\r\n\r\n      /**\r\n       * This block of code is the original way of loading DICOM into dicom-microscopy-viewer\r\n       * as in their documentation.\r\n       * But we have the metadata already loaded by our loaders.\r\n       * As the metadata for microscopy DIOM files tends to be big and we don't\r\n       * want to double load it, below we have the mechanism to reconstruct the\r\n       * DICOM JSON structure (denaturalized) from naturalized metadata.\r\n       * (NOTE: Our loaders cache only naturalized metadata, not the denaturalized.)\r\n       */\r\n      // {\r\n      //   const retrieveOptions = {\r\n      //     studyInstanceUID: metadata[0].StudyInstanceUID,\r\n      //     seriesInstanceUID: metadata[0].SeriesInstanceUID,\r\n      //   };\r\n      //   metadata = await client.retrieveSeriesMetadata(retrieveOptions);\r\n      //   // Parse, format, and filter metadata\r\n      //   metadata.forEach(m => {\r\n      //     if (\r\n      //       volumeImages.length > 0 &&\r\n      //       m['00200052'].Value[0] != volumeImages[0].FrameOfReferenceUID\r\n      //     ) {\r\n      //       console.warn(\r\n      //         'Expected FrameOfReferenceUID of difference instances within a series to be the same, found multiple different values',\r\n      //         m['00200052'].Value[0]\r\n      //       );\r\n      //       m['00200052'].Value[0] = volumeImages[0].FrameOfReferenceUID;\r\n      //     }\r\n      //     NOTE: depending on different data source, image.ImageType sometimes\r\n      //     is a string, not a string array.\r\n      //     m['00080008'] = transformImageTypeUnnaturalized(m['00080008']);\r\n\r\n      //     const image = new metadataUtils.VLWholeSlideMicroscopyImage({\r\n      //       metadata: m,\r\n      //     });\r\n      //     const imageFlavor = image.ImageType[2];\r\n      //     if (imageFlavor === 'VOLUME' || imageFlavor === 'THUMBNAIL') {\r\n      //       volumeImages.push(image);\r\n      //     }\r\n      //   });\r\n      // }\r\n\r\n      metadata.forEach(m => {\r\n        // NOTE: depending on different data source, image.ImageType sometimes\r\n        //    is a string, not a string array.\r\n        m.ImageType =\r\n          typeof m.ImageType === 'string'\r\n            ? m.ImageType.split('\\\\')\r\n            : m.ImageType;\r\n\r\n        const inst = cleanDenaturalizedDataset(\r\n          dcmjs.data.DicomMetaDictionary.denaturalizeDataset(m),\r\n          {\r\n            StudyInstanceUID: m.StudyInstanceUID,\r\n            SeriesInstanceUID: m.SeriesInstanceUID,\r\n            dataSourceConfig: this.props.dataSource.getConfig(),\r\n          }\r\n        );\r\n        if (!inst['00480105']) {\r\n          // Optical Path Sequence, no OpticalPathIdentifier?\r\n          // NOTE: this is actually a not-well formatted DICOM VL Whole Slide Microscopy Image.\r\n          inst['00480105'] = {\r\n            vr: 'SQ',\r\n            Value: [\r\n              {\r\n                '00480106': {\r\n                  vr: 'SH',\r\n                  Value: ['1'],\r\n                },\r\n              },\r\n            ],\r\n          };\r\n        }\r\n        const image = new metadataUtils.VLWholeSlideMicroscopyImage({\r\n          metadata: inst,\r\n        });\r\n\r\n        const imageFlavor = image.ImageType[2];\r\n        if (imageFlavor === 'VOLUME' || imageFlavor === 'THUMBNAIL') {\r\n          volumeImages.push(image);\r\n        }\r\n      });\r\n\r\n      // format metadata for microscopy-viewer\r\n      const options = {\r\n        client,\r\n        metadata: volumeImages,\r\n        retrieveRendered: false,\r\n        controls: ['overview', 'position'],\r\n      };\r\n\r\n      this.viewer = new microscopyViewer(options);\r\n\r\n      if (\r\n        this.overlayElement &&\r\n        this.overlayElement.current &&\r\n        this.viewer.addViewportOverlay\r\n      ) {\r\n        this.viewer.addViewportOverlay({\r\n          element: this.overlayElement.current,\r\n          coordinates: [0, 0], // TODO: dicom-microscopy-viewer documentation says this can be false to be automatically, but it is not.\r\n          navigate: true,\r\n          className: 'OpenLayersOverlay',\r\n        });\r\n      }\r\n\r\n      this.viewer.render({ container });\r\n\r\n      const { StudyInstanceUID, SeriesInstanceUID } = displaySet;\r\n\r\n      this.managedViewer = this.microscopyService.addViewer(\r\n        this.viewer,\r\n        this.props.viewportIndex,\r\n        container,\r\n        StudyInstanceUID,\r\n        SeriesInstanceUID\r\n      );\r\n\r\n      this.managedViewer.addContextMenuCallback((event: Event) => {\r\n        // TODO: refactor this after Bill's changes on ContextMenu feature get merged\r\n        // const roiAnnotationNearBy = this.getNearbyROI(event);\r\n      });\r\n    };\r\n\r\n    this.microscopyService.clearAnnotations();\r\n\r\n    let smDisplaySet = displaySet;\r\n    if (displaySet.Modality === 'SR') {\r\n      // for SR displaySet, let's load the actual image displaySet\r\n      smDisplaySet = displaySet.getSourceDisplaySet();\r\n    }\r\n    console.log('Loading viewer metadata', smDisplaySet);\r\n\r\n    await loadViewer(smDisplaySet.others);\r\n\r\n    if (displaySet.Modality === 'SR') {\r\n      displaySet.load(smDisplaySet);\r\n    }\r\n  }\r\n\r\n  componentDidMount() {\r\n    const { displaySets, viewportIndex } = this.props;\r\n    const displaySet = displaySets[viewportIndex];\r\n    this.installOpenLayersRenderer(this.container.current, displaySet).then(\r\n      () => {\r\n        this.setState({ isLoaded: true });\r\n      }\r\n    );\r\n  }\r\n\r\n  componentDidUpdate(\r\n    prevProps: Readonly<{}>,\r\n    prevState: Readonly<{}>,\r\n    snapshot?: any\r\n  ): void {\r\n    if (\r\n      this.managedViewer &&\r\n      prevProps.displaySets !== this.props.displaySets\r\n    ) {\r\n      const { displaySets } = this.props;\r\n      const displaySet = displaySets[0];\r\n\r\n      this.microscopyService.clearAnnotations();\r\n\r\n      // loading SR\r\n      if (displaySet.Modality === 'SR') {\r\n        const referencedDisplaySet = displaySet.getSourceDisplaySet();\r\n        displaySet.load(referencedDisplaySet);\r\n      }\r\n    }\r\n  }\r\n\r\n  componentWillUnmount() {\r\n    this.microscopyService.removeViewer(this.viewer);\r\n  }\r\n\r\n  setViewportActiveHandler = () => {\r\n    const {\r\n      setViewportActive,\r\n      viewportIndex,\r\n      activeViewportIndex,\r\n    } = this.props;\r\n\r\n    if (viewportIndex !== activeViewportIndex) {\r\n      setViewportActive(viewportIndex);\r\n    }\r\n  };\r\n\r\n  render() {\r\n    const style = { width: '100%', height: '100%' };\r\n    const displaySet = this.props.displaySets[0];\r\n    const firstInstance = displaySet.firstInstance || displaySet.instance;\r\n\r\n    return (\r\n      <div\r\n        className={'DicomMicroscopyViewer'}\r\n        style={style}\r\n        onClick={this.setViewportActiveHandler}\r\n      >\r\n        <div style={{ ...style, display: 'none' }}>\r\n          <div style={{ ...style }} ref={this.overlayElement}>\r\n            <div\r\n              style={{ position: 'relative', height: '100%', width: '100%' }}\r\n            >\r\n              {displaySet && firstInstance.imageId && (\r\n                <ViewportOverlay\r\n                  displaySet={displaySet}\r\n                  instance={displaySet.instance}\r\n                  metadata={displaySet.metadata}\r\n                />\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n        {ReactResizeDetector && (\r\n          <ReactResizeDetector\r\n            handleWidth\r\n            handleHeight\r\n            onResize={this.onWindowResize}\r\n          />\r\n        )}\r\n        {this.state.error ? (\r\n          <h2>{JSON.stringify(this.state.error)}</h2>\r\n        ) : (\r\n          <div style={style} ref={this.container} />\r\n        )}\r\n        {this.state.isLoaded ? null : (\r\n          <LoadingIndicatorProgress className={'w-full h-full bg-black'} />\r\n        )}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  onWindowResize = () => {\r\n    this.debouncedResize();\r\n  };\r\n}\r\n\r\nexport default DicomMicroscopyViewport;\r\n"],"names":["props","list","itemGenerator","map","item","generator","Error","_ref","topLeft","topRight","bottomLeft","bottomRight","overlay","React","length","className","classnames","listComponentGenerator","DICOMwebClient","api","_buildMultipartAcceptHeaderFieldValue","isPrimitive","v","Array","isArray","vrNumerics","cleanDenaturalizedDataset","obj","options","o","Object","keys","forEach","key","Value","vr","BulkDataURI","dicomWebUtils","dataSourceConfig","window","location","protocol","startsWith","replace","includes","entry","DicomMicroscopyViewport","Component","constructor","super","state","error","isLoaded","microscopyService","viewer","managedViewer","container","overlayElement","debouncedResize","setViewportActiveHandler","setViewportActive","viewportIndex","activeViewportIndex","this","onWindowResize","servicesManager","services","debounce","resize","getNearbyROI","event","autoselect","arguments","undefined","symbols","getOwnPropertySymbols","_drawingSource","find","p","description","_pyramid","_map","_affine","feature","getClosestFeatureToCoordinate","getEventCoordinate","roiAnnotation","_getROIFromFeature","metadata","selectAnnotation","async","displaySet","clearAnnotations","smDisplaySet","Modality","getSourceDisplaySet","console","log","DicomMicroscopyViewer","metadataUtils","microscopyViewer","VolumeImageViewer","client","extensionManager","config","dataSources","ds","sourceName","activeDataSource","userAuthenticationService","wadoRoot","staticWado","singlepart","configuration","wadoConfig","url","headers","getAuthorizationHeader","errorInterceptor","errorHandler","getHTTPErrorHandler","wadoURL","retrieveInstanceFrames","frameNumbers","toString","sopInstanceUID","instance","DicomMetadataStore","getInstance","studyInstanceUID","seriesInstanceUID","split","fr","PixelData","getDicomWebClient","volumeImages","m","ImageType","inst","dcmjs","DicomMetaDictionary","denaturalizeDataset","StudyInstanceUID","SeriesInstanceUID","dataSource","getConfig","image","VLWholeSlideMicroscopyImage","imageFlavor","push","retrieveRendered","controls","current","addViewportOverlay","element","coordinates","navigate","render","addViewer","addContextMenuCallback","loadViewer","others","load","componentDidMount","displaySets","installOpenLayersRenderer","then","setState","componentDidUpdate","prevProps","prevState","snapshot","referencedDisplaySet","componentWillUnmount","removeViewer","style","width","height","firstInstance","onClick","display","ref","position","imageId","ViewportOverlay","ReactResizeDetector","handleWidth","handleHeight","onResize","JSON","stringify","LoadingIndicatorProgress","propTypes","viewportData","PropTypes","viewportLabel","viewportOptions","displaySetOptions","commandsManager"],"sourceRoot":""}