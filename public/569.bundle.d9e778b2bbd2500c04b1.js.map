{"version":3,"file":"569.bundle.d9e778b2bbd2500c04b1.js","mappings":"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","sources":["webpack:///../../../extensions/cornerstone-dicom-seg/src/utils/initSEGToolGroup.ts","webpack:///../../../extensions/cornerstone-dicom-seg/src/utils/_hydrateSEG.ts","webpack:///../../../extensions/cornerstone-dicom-seg/src/utils/promptHydrateSEG.ts","webpack:///../../../extensions/cornerstone-dicom-seg/src/viewports/OHIFCornerstoneSEGViewport.tsx","webpack:///../../../extensions/cornerstone-dicom-seg/src/viewports/_getStatusComponent.tsx"],"sourcesContent":["function createSEGToolGroupAndAddTools(\r\n  ToolGroupService,\r\n  customizationService,\r\n  toolGroupId\r\n) {\r\n  const { tools } =\r\n    customizationService.get('cornerstone.overlayViewportTools') ?? {};\r\n\r\n  return ToolGroupService.createToolGroupAndAddTools(toolGroupId, tools, {});\r\n}\r\n\r\nexport default createSEGToolGroupAndAddTools;\r\n","async function _hydrateSEGDisplaySet({\r\n  segDisplaySet,\r\n  viewportIndex,\r\n  servicesManager,\r\n}) {\r\n  const {\r\n    segmentationService,\r\n    hangingProtocolService,\r\n    viewportGridService,\r\n  } = servicesManager.services;\r\n\r\n  const displaySetInstanceUID = segDisplaySet.referencedDisplaySetInstanceUID;\r\n\r\n  let segmentationId = null;\r\n\r\n  // We need the hydration to notify panels about the new segmentation added\r\n  const suppressEvents = false;\r\n\r\n  segmentationId = await segmentationService.createSegmentationForSEGDisplaySet(\r\n    segDisplaySet,\r\n    segmentationId,\r\n    suppressEvents\r\n  );\r\n\r\n  segmentationService.hydrateSegmentation(segDisplaySet.displaySetInstanceUID);\r\n\r\n  const { viewports } = viewportGridService.getState();\r\n\r\n  const updatedViewports = hangingProtocolService.getViewportsRequireUpdate(\r\n    viewportIndex,\r\n    displaySetInstanceUID\r\n  );\r\n\r\n  // Todo: fix this after we have a better way for stack viewport segmentations\r\n\r\n  // check every viewport in the viewports to see if the displaySetInstanceUID\r\n  // is being displayed, if so we need to update the viewport to use volume viewport\r\n  // (if already is not using it) since Cornerstone3D currently only supports\r\n  // volume viewport for segmentation\r\n  viewports.forEach((viewport, index) => {\r\n    if (index === viewportIndex) {\r\n      return;\r\n    }\r\n\r\n    const shouldDisplaySeg = segmentationService.shouldRenderSegmentation(\r\n      viewport.displaySetInstanceUIDs,\r\n      segDisplaySet.displaySetInstanceUID\r\n    );\r\n\r\n    if (shouldDisplaySeg) {\r\n      updatedViewports.push({\r\n        viewportIndex: index,\r\n        displaySetInstanceUIDs: viewport.displaySetInstanceUIDs,\r\n        viewportOptions: {\r\n          initialImageOptions: {\r\n            preset: 'middle',\r\n          },\r\n        },\r\n      });\r\n    }\r\n  });\r\n\r\n  // Do the entire update at once\r\n  viewportGridService.setDisplaySetsForViewports(updatedViewports);\r\n\r\n  return true;\r\n}\r\n\r\nexport default _hydrateSEGDisplaySet;\r\n","import { ButtonEnums } from '@ohif/ui';\r\nimport hydrateSEGDisplaySet from './_hydrateSEG';\r\n\r\nconst RESPONSE = {\r\n  NO_NEVER: -1,\r\n  CANCEL: 0,\r\n  HYDRATE_SEG: 5,\r\n};\r\n\r\nfunction promptHydrateSEG({ servicesManager, segDisplaySet, viewportIndex }) {\r\n  const { uiViewportDialogService } = servicesManager.services;\r\n\r\n  return new Promise(async function(resolve, reject) {\r\n    const promptResult = await _askHydrate(\r\n      uiViewportDialogService,\r\n      viewportIndex\r\n    );\r\n\r\n    if (promptResult === RESPONSE.HYDRATE_SEG) {\r\n      const isHydrated = await hydrateSEGDisplaySet({\r\n        segDisplaySet,\r\n        viewportIndex,\r\n        servicesManager,\r\n      });\r\n\r\n      resolve(isHydrated);\r\n    }\r\n  });\r\n}\r\n\r\nfunction _askHydrate(uiViewportDialogService, viewportIndex) {\r\n  return new Promise(function(resolve, reject) {\r\n    const message = 'Do you want to open this Segmentation?';\r\n    const actions = [\r\n      {\r\n        type: ButtonEnums.type.secondary,\r\n        text: 'No',\r\n        value: RESPONSE.CANCEL,\r\n      },\r\n      {\r\n        type: ButtonEnums.type.primary,\r\n        text: 'Yes',\r\n        value: RESPONSE.HYDRATE_SEG,\r\n      },\r\n    ];\r\n    const onSubmit = result => {\r\n      uiViewportDialogService.hide();\r\n      resolve(result);\r\n    };\r\n\r\n    uiViewportDialogService.show({\r\n      viewportIndex,\r\n      type: 'info',\r\n      message,\r\n      actions,\r\n      onSubmit,\r\n      onOutsideClick: () => {\r\n        uiViewportDialogService.hide();\r\n        resolve(RESPONSE.CANCEL);\r\n      },\r\n    });\r\n  });\r\n}\r\n\r\nexport default promptHydrateSEG;\r\n","import PropTypes from 'prop-types';\r\nimport React, { useCallback, useEffect, useRef, useState } from 'react';\r\nimport { useTranslation } from 'react-i18next';\r\nimport OHIF, { utils } from '@ohif/core';\r\nimport {\r\n  LoadingIndicatorTotalPercent,\r\n  useViewportGrid,\r\n  ViewportActionBar,\r\n} from '@ohif/ui';\r\nimport createSEGToolGroupAndAddTools from '../utils/initSEGToolGroup';\r\nimport promptHydrateSEG from '../utils/promptHydrateSEG';\r\nimport hydrateSEGDisplaySet from '../utils/_hydrateSEG';\r\nimport _getStatusComponent from './_getStatusComponent';\r\n\r\nconst { formatDate } = utils;\r\nconst SEG_TOOLGROUP_BASE_NAME = 'SEGToolGroup';\r\n\r\nfunction OHIFCornerstoneSEGViewport(props) {\r\n  const {\r\n    children,\r\n    displaySets,\r\n    viewportOptions,\r\n    viewportIndex,\r\n    viewportLabel,\r\n    servicesManager,\r\n    extensionManager,\r\n  } = props;\r\n\r\n  const { t } = useTranslation('SEGViewport');\r\n\r\n  const {\r\n    displaySetService,\r\n    toolGroupService,\r\n    segmentationService,\r\n    uiNotificationService,\r\n    customizationService,\r\n  } = servicesManager.services;\r\n\r\n  const toolGroupId = `${SEG_TOOLGROUP_BASE_NAME}-${viewportIndex}`;\r\n\r\n  // SEG viewport will always have a single display set\r\n  if (displaySets.length > 1) {\r\n    throw new Error('SEG viewport should only have a single display set');\r\n  }\r\n\r\n  const segDisplaySet = displaySets[0];\r\n\r\n  const [viewportGrid, viewportGridService] = useViewportGrid();\r\n\r\n  // States\r\n  const [isToolGroupCreated, setToolGroupCreated] = useState(false);\r\n  const [selectedSegment, setSelectedSegment] = useState(1);\r\n\r\n  // Hydration means that the SEG is opened and segments are loaded into the\r\n  // segmentation panel, and SEG is also rendered on any viewport that is in the\r\n  // same frameOfReferenceUID as the referencedSeriesUID of the SEG. However,\r\n  // loading basically means SEG loading over network and bit unpacking of the\r\n  // SEG data.\r\n  const [isHydrated, setIsHydrated] = useState(segDisplaySet.isHydrated);\r\n  const [segIsLoading, setSegIsLoading] = useState(!segDisplaySet.isLoaded);\r\n  const [element, setElement] = useState(null);\r\n  const [processingProgress, setProcessingProgress] = useState({\r\n    percentComplete: null,\r\n    totalSegments: null,\r\n  });\r\n\r\n  // refs\r\n  const referencedDisplaySetRef = useRef(null);\r\n\r\n  const { viewports, activeViewportIndex } = viewportGrid;\r\n\r\n  const referencedDisplaySet = segDisplaySet.getReferenceDisplaySet();\r\n  const referencedDisplaySetMetadata = _getReferencedDisplaySetMetadata(\r\n    referencedDisplaySet,\r\n    segDisplaySet\r\n  );\r\n\r\n  referencedDisplaySetRef.current = {\r\n    displaySet: referencedDisplaySet,\r\n    metadata: referencedDisplaySetMetadata,\r\n  };\r\n  /**\r\n   * OnElementEnabled callback which is called after the cornerstoneExtension\r\n   * has enabled the element. Note: we delegate all the image rendering to\r\n   * cornerstoneExtension, so we don't need to do anything here regarding\r\n   * the image rendering, element enabling etc.\r\n   */\r\n  const onElementEnabled = evt => {\r\n    setElement(evt.detail.element);\r\n  };\r\n\r\n  const onElementDisabled = () => {\r\n    setElement(null);\r\n  };\r\n\r\n  const getCornerstoneViewport = useCallback(() => {\r\n    const { component: Component } = extensionManager.getModuleEntry(\r\n      '@ohif/extension-cornerstone.viewportModule.cornerstone'\r\n    );\r\n\r\n    const {\r\n      displaySet: referencedDisplaySet,\r\n    } = referencedDisplaySetRef.current;\r\n\r\n    // Todo: jump to the center of the first segment\r\n    return (\r\n      <Component\r\n        {...props}\r\n        displaySets={[referencedDisplaySet, segDisplaySet]}\r\n        viewportOptions={{\r\n          viewportType: 'volume',\r\n          toolGroupId: toolGroupId,\r\n          orientation: viewportOptions.orientation,\r\n          viewportId: viewportOptions.viewportId,\r\n        }}\r\n        onElementEnabled={onElementEnabled}\r\n        onElementDisabled={onElementDisabled}\r\n        // initialImageIndex={initialImageIndex}\r\n      ></Component>\r\n    );\r\n  }, [viewportIndex, segDisplaySet, toolGroupId]);\r\n\r\n  const onSegmentChange = useCallback(\r\n    direction => {\r\n      direction = direction === 'left' ? -1 : 1;\r\n      const segmentationId = segDisplaySet.displaySetInstanceUID;\r\n      const segmentation = segmentationService.getSegmentation(segmentationId);\r\n\r\n      const { segments } = segmentation;\r\n\r\n      const numberOfSegments = Object.keys(segments).length;\r\n\r\n      let newSelectedSegmentIndex = selectedSegment + direction;\r\n\r\n      // Segment 0 is always background\r\n\r\n      if (newSelectedSegmentIndex > numberOfSegments - 1) {\r\n        newSelectedSegmentIndex = 1;\r\n      } else if (newSelectedSegmentIndex === 0) {\r\n        newSelectedSegmentIndex = numberOfSegments - 1;\r\n      }\r\n\r\n      segmentationService.jumpToSegmentCenter(\r\n        segmentationId,\r\n        newSelectedSegmentIndex,\r\n        toolGroupId\r\n      );\r\n      setSelectedSegment(newSelectedSegmentIndex);\r\n    },\r\n    [selectedSegment]\r\n  );\r\n\r\n  useEffect(() => {\r\n    if (segIsLoading) {\r\n      return;\r\n    }\r\n\r\n    promptHydrateSEG({\r\n      servicesManager,\r\n      viewportIndex,\r\n      segDisplaySet,\r\n    }).then(isHydrated => {\r\n      if (isHydrated) {\r\n        setIsHydrated(true);\r\n      }\r\n    });\r\n  }, [servicesManager, viewportIndex, segDisplaySet, segIsLoading]);\r\n\r\n  useEffect(() => {\r\n    const { unsubscribe } = segmentationService.subscribe(\r\n      segmentationService.EVENTS.SEGMENTATION_LOADING_COMPLETE,\r\n      evt => {\r\n        if (\r\n          evt.segDisplaySet.displaySetInstanceUID ===\r\n          segDisplaySet.displaySetInstanceUID\r\n        ) {\r\n          setSegIsLoading(false);\r\n        }\r\n\r\n        if (evt.overlappingSegments) {\r\n          uiNotificationService.show({\r\n            title: 'Overlapping Segments',\r\n            message:\r\n              'Overlapping segments detected which is not currently supported',\r\n            type: 'warning',\r\n          });\r\n        }\r\n      }\r\n    );\r\n\r\n    return () => {\r\n      unsubscribe();\r\n    };\r\n  }, [segDisplaySet]);\r\n\r\n  useEffect(() => {\r\n    const { unsubscribe } = segmentationService.subscribe(\r\n      segmentationService.EVENTS.SEGMENT_LOADING_COMPLETE,\r\n      ({ percentComplete, numSegments }) => {\r\n        setProcessingProgress({\r\n          percentComplete,\r\n          totalSegments: numSegments,\r\n        });\r\n      }\r\n    );\r\n\r\n    return () => {\r\n      unsubscribe();\r\n    };\r\n  }, [segDisplaySet]);\r\n\r\n  /**\r\n   Cleanup the SEG viewport when the viewport is destroyed\r\n   */\r\n  useEffect(() => {\r\n    const onDisplaySetsRemovedSubscription = displaySetService.subscribe(\r\n      displaySetService.EVENTS.DISPLAY_SETS_REMOVED,\r\n      ({ displaySetInstanceUIDs }) => {\r\n        const activeViewport = viewports[activeViewportIndex];\r\n        if (\r\n          displaySetInstanceUIDs.includes(activeViewport.displaySetInstanceUID)\r\n        ) {\r\n          viewportGridService.setDisplaySetsForViewport({\r\n            viewportIndex: activeViewportIndex,\r\n            displaySetInstanceUIDs: [],\r\n          });\r\n        }\r\n      }\r\n    );\r\n\r\n    return () => {\r\n      onDisplaySetsRemovedSubscription.unsubscribe();\r\n    };\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    let toolGroup = toolGroupService.getToolGroup(toolGroupId);\r\n\r\n    if (toolGroup) {\r\n      return;\r\n    }\r\n\r\n    // This creates a custom tool group which has the lifetime of this view\r\n    // only, and does NOT interfere with currently displayed segmentations.\r\n    toolGroup = createSEGToolGroupAndAddTools(\r\n      toolGroupService,\r\n      customizationService,\r\n      toolGroupId\r\n    );\r\n\r\n    setToolGroupCreated(true);\r\n\r\n    return () => {\r\n      // remove the segmentation representations if seg displayset changed\r\n      segmentationService.removeSegmentationRepresentationFromToolGroup(\r\n        toolGroupId\r\n      );\r\n\r\n      // Only destroy the viewport specific implementation\r\n      toolGroupService.destroyToolGroup(toolGroupId);\r\n    };\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    setIsHydrated(segDisplaySet.isHydrated);\r\n\r\n    return () => {\r\n      // remove the segmentation representations if seg displayset changed\r\n      segmentationService.removeSegmentationRepresentationFromToolGroup(\r\n        toolGroupId\r\n      );\r\n      referencedDisplaySetRef.current = null;\r\n    };\r\n  }, [segDisplaySet]);\r\n\r\n  // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n  let childrenWithProps = null;\r\n\r\n  if (\r\n    !referencedDisplaySetRef.current ||\r\n    referencedDisplaySet.displaySetInstanceUID !==\r\n      referencedDisplaySetRef.current.displaySet.displaySetInstanceUID\r\n  ) {\r\n    return null;\r\n  }\r\n\r\n  if (children && children.length) {\r\n    childrenWithProps = children.map((child, index) => {\r\n      return (\r\n        child &&\r\n        React.cloneElement(child, {\r\n          viewportIndex,\r\n          key: index,\r\n        })\r\n      );\r\n    });\r\n  }\r\n\r\n  const {\r\n    PatientID,\r\n    PatientName,\r\n    PatientSex,\r\n    PatientAge,\r\n    SliceThickness,\r\n    ManufacturerModelName,\r\n    StudyDate,\r\n    SeriesDescription,\r\n    SpacingBetweenSlices,\r\n  } = referencedDisplaySetRef.current.metadata;\r\n\r\n  const onStatusClick = async () => {\r\n    const isHydrated = await hydrateSEGDisplaySet({\r\n      segDisplaySet,\r\n      viewportIndex,\r\n      servicesManager,\r\n    });\r\n\r\n    setIsHydrated(isHydrated);\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <ViewportActionBar\r\n        onDoubleClick={evt => {\r\n          evt.stopPropagation();\r\n          evt.preventDefault();\r\n        }}\r\n        onArrowsClick={onSegmentChange}\r\n        getStatusComponent={() => {\r\n          return _getStatusComponent({\r\n            isHydrated,\r\n            onStatusClick,\r\n          });\r\n        }}\r\n        studyData={{\r\n          label: viewportLabel,\r\n          useAltStyling: true,\r\n          studyDate: formatDate(StudyDate),\r\n          seriesDescription: `SEG Viewport ${SeriesDescription}`,\r\n          patientInformation: {\r\n            patientName: PatientName\r\n              ? OHIF.utils.formatPN(PatientName.Alphabetic)\r\n              : '',\r\n            patientSex: PatientSex || '',\r\n            patientAge: PatientAge || '',\r\n            MRN: PatientID || '',\r\n            thickness: SliceThickness ? `${SliceThickness.toFixed(2)}mm` : '',\r\n            spacing:\r\n              SpacingBetweenSlices !== undefined\r\n                ? `${SpacingBetweenSlices.toFixed(2)}mm`\r\n                : '',\r\n            scanner: ManufacturerModelName || '',\r\n          },\r\n        }}\r\n      />\r\n\r\n      <div className=\"relative flex flex-row w-full h-full overflow-hidden\">\r\n        {segIsLoading && (\r\n          <LoadingIndicatorTotalPercent\r\n            className=\"w-full h-full\"\r\n            totalNumbers={processingProgress.totalSegments}\r\n            percentComplete={processingProgress.percentComplete}\r\n            loadingText=\"Loading SEG...\"\r\n          />\r\n        )}\r\n        {getCornerstoneViewport()}\r\n        {childrenWithProps}\r\n      </div>\r\n    </>\r\n  );\r\n}\r\n\r\nOHIFCornerstoneSEGViewport.propTypes = {\r\n  displaySets: PropTypes.arrayOf(PropTypes.object),\r\n  viewportIndex: PropTypes.number.isRequired,\r\n  dataSource: PropTypes.object,\r\n  children: PropTypes.node,\r\n  customProps: PropTypes.object,\r\n};\r\n\r\nOHIFCornerstoneSEGViewport.defaultProps = {\r\n  customProps: {},\r\n};\r\n\r\nfunction _getReferencedDisplaySetMetadata(referencedDisplaySet, segDisplaySet) {\r\n  const {\r\n    SharedFunctionalGroupsSequence: [SharedFunctionalGroup],\r\n  } = segDisplaySet.instance;\r\n  const {\r\n    PixelMeasuresSequence: [PixelMeasures],\r\n  } = SharedFunctionalGroup;\r\n  const { SpacingBetweenSlices, SliceThickness } = PixelMeasures;\r\n\r\n  const image0 = referencedDisplaySet.images[0];\r\n  const referencedDisplaySetMetadata = {\r\n    PatientID: image0.PatientID,\r\n    PatientName: image0.PatientName,\r\n    PatientSex: image0.PatientSex,\r\n    PatientAge: image0.PatientAge,\r\n    SliceThickness: image0.SliceThickness || SliceThickness,\r\n    StudyDate: image0.StudyDate,\r\n    SeriesDescription: image0.SeriesDescription,\r\n    SeriesInstanceUID: image0.SeriesInstanceUID,\r\n    SeriesNumber: image0.SeriesNumber,\r\n    ManufacturerModelName: image0.ManufacturerModelName,\r\n    SpacingBetweenSlices: image0.SpacingBetweenSlices || SpacingBetweenSlices,\r\n  };\r\n\r\n  return referencedDisplaySetMetadata;\r\n}\r\n\r\nexport default OHIFCornerstoneSEGViewport;\r\n","import React from 'react';\r\nimport { useTranslation } from 'react-i18next';\r\nimport { Icon, Tooltip } from '@ohif/ui';\r\n\r\n\r\nexport default function _getStatusComponent({ isHydrated, onStatusClick }) {\r\n  let ToolTipMessage = null;\r\n  let StatusIcon = null;\r\n\r\n  const {t} = useTranslation(\"Common\");\r\n  const loadStr = t(\"LOAD\");\r\n\r\n  switch (isHydrated) {\r\n    case true:\r\n      StatusIcon = () => <Icon name=\"status-alert\" />;\r\n\r\n      ToolTipMessage = () => (\r\n        <div>This Segmentation is loaded in the segmentation panel</div>\r\n      );\r\n      break;\r\n  case false:\r\n      StatusIcon = () => <Icon name=\"status-untracked\" />;\r\n\r\n      ToolTipMessage = () => <div>Click LOAD to load segmentation.</div>;\r\n  }\r\n\r\n  const StatusArea = () => (\r\n    <div className=\"flex h-6 leading-6 cursor-default text-sm text-white\">\r\n      <div className=\"min-w-[45px] flex items-center p-1 rounded-l-xl rounded-r bg-customgray-100\">\r\n        <StatusIcon />\r\n        <span className=\"ml-1\">SEG</span>\r\n      </div>\r\n      {!isHydrated && (\r\n        <div\r\n          className=\"ml-1 px-1.5 rounded cursor-pointer hover:text-black bg-primary-main hover:bg-primary-light\"\r\n          // Using onMouseUp here because onClick is not working when the viewport is not active and is styled with pointer-events:none\r\n          onMouseUp={onStatusClick}\r\n        >\r\n          {loadStr}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n\r\n\r\n  return (\r\n    <>\r\n      {ToolTipMessage && (\r\n        <Tooltip content={<ToolTipMessage />} position=\"bottom-left\">\r\n          <StatusArea />\r\n        </Tooltip>\r\n      )}\r\n      {!ToolTipMessage && <StatusArea />}\r\n    </>\r\n  );\r\n}\r\n"],"names":["ToolGroupService","customizationService","toolGroupId","tools","get","createToolGroupAndAddTools","async","_ref","segDisplaySet","viewportIndex","servicesManager","segmentationService","hangingProtocolService","viewportGridService","services","displaySetInstanceUID","referencedDisplaySetInstanceUID","segmentationId","createSegmentationForSEGDisplaySet","hydrateSegmentation","viewports","getState","updatedViewports","getViewportsRequireUpdate","forEach","viewport","index","shouldRenderSegmentation","displaySetInstanceUIDs","push","viewportOptions","initialImageOptions","preset","setDisplaySetsForViewports","RESPONSE","NO_NEVER","CANCEL","HYDRATE_SEG","uiViewportDialogService","Promise","resolve","reject","promptResult","message","actions","type","ButtonEnums","secondary","text","value","primary","onSubmit","result","hide","show","onOutsideClick","_askHydrate","hydrateSEGDisplaySet","formatDate","utils","OHIFCornerstoneSEGViewport","props","children","displaySets","viewportLabel","extensionManager","t","useTranslation","displaySetService","toolGroupService","uiNotificationService","length","Error","viewportGrid","useViewportGrid","isToolGroupCreated","setToolGroupCreated","useState","selectedSegment","setSelectedSegment","isHydrated","setIsHydrated","segIsLoading","setSegIsLoading","isLoaded","element","setElement","processingProgress","setProcessingProgress","percentComplete","totalSegments","referencedDisplaySetRef","useRef","activeViewportIndex","referencedDisplaySet","getReferenceDisplaySet","referencedDisplaySetMetadata","SharedFunctionalGroupsSequence","SharedFunctionalGroup","instance","PixelMeasuresSequence","PixelMeasures","SpacingBetweenSlices","SliceThickness","image0","images","PatientID","PatientName","PatientSex","PatientAge","StudyDate","SeriesDescription","SeriesInstanceUID","SeriesNumber","ManufacturerModelName","_getReferencedDisplaySetMetadata","current","displaySet","metadata","onElementEnabled","evt","detail","onElementDisabled","getCornerstoneViewport","useCallback","component","Component","getModuleEntry","React","_extends","viewportType","orientation","viewportId","onSegmentChange","direction","segmentation","getSegmentation","segments","numberOfSegments","Object","keys","newSelectedSegmentIndex","jumpToSegmentCenter","useEffect","promptHydrateSEG","then","unsubscribe","subscribe","EVENTS","SEGMENTATION_LOADING_COMPLETE","overlappingSegments","title","SEGMENT_LOADING_COMPLETE","numSegments","onDisplaySetsRemovedSubscription","DISPLAY_SETS_REMOVED","_ref2","activeViewport","includes","setDisplaySetsForViewport","toolGroup","getToolGroup","createSEGToolGroupAndAddTools","removeSegmentationRepresentationFromToolGroup","destroyToolGroup","childrenWithProps","map","child","key","onStatusClick","ViewportActionBar","onDoubleClick","stopPropagation","preventDefault","onArrowsClick","getStatusComponent","ToolTipMessage","StatusIcon","loadStr","Icon","name","StatusArea","className","onMouseUp","Tooltip","content","position","_getStatusComponent","studyData","label","useAltStyling","studyDate","seriesDescription","patientInformation","patientName","OHIF","formatPN","Alphabetic","patientSex","patientAge","MRN","thickness","toFixed","spacing","undefined","scanner","LoadingIndicatorTotalPercent","totalNumbers","loadingText","propTypes","PropTypes","isRequired","dataSource","customProps","defaultProps"],"sourceRoot":""}